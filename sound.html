<!doctype html5>
<html>
<head>
</head>

<body>
<canvas id="canvas">
</canvas>

<script type="text/javascript" src="js/tine.js"></script>
<script type="text/javascript" src="js/music_box.js"></script>
<script type="text/javascript">
function loadImage (src, callback) {
  var img = new Image ()
  img.onload = function () { callback (img) }
  img.src = src
}

function toAudio (id, rate, bpm) {
  var frame = Math.floor (rate * 30 / bpm),
      buffer = new Array (frame * id.height),
      box = new MusicBox (rate, 1 / 16, [
         523.25,
         587.33,
         659.26,
         698.46,
         783.99,
         880.00,
         987.77,
        1046.50,
        1174.66,
        1318.51,
        1396.91,
        1567.98,
        1760.00,
        1975.53,
        2093.00
      ]),
      i = 0,
      j = 0,
      x, y

  for (y = 0; y !== id.height; ++y) {
    /* Strike notes. */
    for (x = 0; x !== id.width; ++x, i += 4)
      if (id.data[i] + id.data[i + 1] + id.data[i + 2] === 0)
        box.strike (x)

    /* Resonate for the frame length. */
    for (x = frame; x--; ++j)
      buffer[j] = box.next ()
  }

  return buffer
}

loadImage ("img/sarias-song.png", function (img) {
  var canvas = document.getElementById ("canvas"),
      width = img.width,
      height = img.height

  canvas.width = width
  canvas.height = height

  var ctx = canvas.getContext ("2d")

  ctx.drawImage (img, 0, 0)

  var id = ctx.getImageData (0, 0, width, height),
      audio = new Audio ()

  audio.mozSetup (1, 22050)
  audio.mozWriteAudio (toAudio (id, 22050, 120))
})
</script>
</body>
</html>
